<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>ecto on cone.codes</title><link>https://cone.codes/tags/ecto/</link><description>Recent content in ecto on cone.codes</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><copyright>Creative Commons Attribution 4.0 International</copyright><lastBuildDate>Fri, 21 Jan 2022 14:36:40 -0700</lastBuildDate><atom:link href="https://cone.codes/tags/ecto/index.xml" rel="self" type="application/rss+xml"/><item><title>Encrypted SQLite With Ecto</title><link>https://cone.codes/posts/encrypted-sqlite-with-ecto/</link><pubDate>Fri, 21 Jan 2022 14:36:40 -0700</pubDate><guid>https://cone.codes/posts/encrypted-sqlite-with-ecto/</guid><description>TLDR Compiling SQLCipher:
./configure \ --enable-tempstore=yes \ --disable-tcl \ --enable-shared \ CFLAGS=&amp;#34;-DSQLITE_HAS_CODEC -DSQLITE_THREADSAFE=1 -DSQLITE_USE_URI=1 -DSQLITE_LIKE_DOESNT_MATCH_BLOBS=1 -DSQLITE_DQS=0 -DHAVE_USLEEP=1 -DALLOW_COVERING_INDEX_SCAN=1 -DENABLE_FTS3_PARENTHESIS=1 -DENABLE_LOAD_EXTENSION=1 -DENABLE_SOUNDEX=1 -DENABLE_STAT4=1 -DENABLE_UPDATE_DELETE_LIMIT=1 -DSQLITE_ENABLE_FTS3=1 -DSQLITE_ENABLE_FTS4=1 -DSQLITE_ENABLE_FTS5=1 -DSQLITE_ENABLE_GEOPOLY=1 -DSQLITE_ENABLE_JSON1=1 -DSQLITE_ENABLE_MATH_FUNCTIONS=1 -DSQLITE_ENABLE_RBU=1 -DSQLITE_ENABLE_RTREE=1 -DSQLITE_OMIT_DEPRECATED=1&amp;#34; \ LDFLAGS=&amp;#34;-lcrypto&amp;#34; Encrypting SQLite databases SQLite is one of my favorite pieces of software in the world. It&amp;rsquo;s used in millions of projects and devices. One issue with the official public version of it is that there is no support for encryption natively.</description><content>&lt;h1 id="tldr">TLDR&lt;/h1>
&lt;p>Compiling SQLCipher:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">./configure &lt;span style="color:#ae81ff">\
&lt;/span>&lt;span style="color:#ae81ff">&lt;/span> --enable-tempstore&lt;span style="color:#f92672">=&lt;/span>yes &lt;span style="color:#ae81ff">\
&lt;/span>&lt;span style="color:#ae81ff">&lt;/span> --disable-tcl &lt;span style="color:#ae81ff">\
&lt;/span>&lt;span style="color:#ae81ff">&lt;/span> --enable-shared &lt;span style="color:#ae81ff">\
&lt;/span>&lt;span style="color:#ae81ff">&lt;/span> CFLAGS&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;-DSQLITE_HAS_CODEC -DSQLITE_THREADSAFE=1 -DSQLITE_USE_URI=1 -DSQLITE_LIKE_DOESNT_MATCH_BLOBS=1 -DSQLITE_DQS=0 -DHAVE_USLEEP=1 -DALLOW_COVERING_INDEX_SCAN=1 -DENABLE_FTS3_PARENTHESIS=1 -DENABLE_LOAD_EXTENSION=1 -DENABLE_SOUNDEX=1 -DENABLE_STAT4=1 -DENABLE_UPDATE_DELETE_LIMIT=1 -DSQLITE_ENABLE_FTS3=1 -DSQLITE_ENABLE_FTS4=1 -DSQLITE_ENABLE_FTS5=1 -DSQLITE_ENABLE_GEOPOLY=1 -DSQLITE_ENABLE_JSON1=1 -DSQLITE_ENABLE_MATH_FUNCTIONS=1 -DSQLITE_ENABLE_RBU=1 -DSQLITE_ENABLE_RTREE=1 -DSQLITE_OMIT_DEPRECATED=1&amp;#34;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;span style="color:#ae81ff">&lt;/span> LDFLAGS&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;-lcrypto&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h1 id="encrypting-sqlite-databases">Encrypting SQLite databases&lt;/h1>
&lt;p>SQLite is one of my favorite pieces of software in the world. It&amp;rsquo;s used in millions
of projects and devices. One issue with the official public version of it is that
there is no support for encryption natively. The primary decision for this seems to be
for monetizing the work of the developers.&lt;/p>
&lt;p>What this means is that to encrypt your SQLite database, you actually have to recompile
the entire engine from source, with licensed files. You can read more about the
official SQLite encryption &lt;a href="https://www.sqlite.org/see/doc/trunk/www/readme.wiki">on the official website&lt;/a>&lt;/p>
&lt;p>An alternative option to SQLite encryption that is free and open source is &lt;a href="https://www.zetetic.net/sqlcipher/">SQLCipher&lt;/a>.
It implements a similar API and to the offical SEE release, and also requires you to compile the engine from source.&lt;/p>
&lt;h2 id="compiling-sqlcipher">Compiling SQLCipher&lt;/h2>
&lt;p>This is the most time consuming part of the process. Luckily it only needs to be done once.&lt;/p>
&lt;pre>&lt;code>NOTE: this is specifically for your development environment. Compiling for production
*may* look the same to you, but it may not. This is specifically a problem for Nerves
which I will write a follow-up post about in the future.
&lt;/code>&lt;/pre>
&lt;p>The first step for compiling SQLCipher is getting the source. I chose to use the latest tagged release,
a git clone will work the same.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">wget https://github.com/sqlcipher/sqlcipher/archive/refs/tags/v4.5.0.tar.gz
tar xzf v4.5.0.tar.gz
cd sqlcipher-4.5.0
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Next up, use autotools to configure the build. These are the settings I suggest starting with:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">./configure &lt;span style="color:#ae81ff">\
&lt;/span>&lt;span style="color:#ae81ff">&lt;/span> --enable-tempstore&lt;span style="color:#f92672">=&lt;/span>yes &lt;span style="color:#ae81ff">\
&lt;/span>&lt;span style="color:#ae81ff">&lt;/span> --disable-tcl &lt;span style="color:#ae81ff">\
&lt;/span>&lt;span style="color:#ae81ff">&lt;/span> --enable-shared &lt;span style="color:#ae81ff">\
&lt;/span>&lt;span style="color:#ae81ff">&lt;/span> CFLAGS&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;-DSQLITE_HAS_CODEC -DSQLITE_THREADSAFE=1 -DSQLITE_USE_URI=1 -DSQLITE_LIKE_DOESNT_MATCH_BLOBS=1 -DSQLITE_DQS=0 -DHAVE_USLEEP=1 -DALLOW_COVERING_INDEX_SCAN=1 -DENABLE_FTS3_PARENTHESIS=1 -DENABLE_LOAD_EXTENSION=1 -DENABLE_SOUNDEX=1 -DENABLE_STAT4=1 -DENABLE_UPDATE_DELETE_LIMIT=1 -DSQLITE_ENABLE_FTS3=1 -DSQLITE_ENABLE_FTS4=1 -DSQLITE_ENABLE_FTS5=1 -DSQLITE_ENABLE_GEOPOLY=1 -DSQLITE_ENABLE_JSON1=1 -DSQLITE_ENABLE_MATH_FUNCTIONS=1 -DSQLITE_ENABLE_RBU=1 -DSQLITE_ENABLE_RTREE=1 -DSQLITE_OMIT_DEPRECATED=1&amp;#34;&lt;/span> &lt;span style="color:#ae81ff">\
&lt;/span>&lt;span style="color:#ae81ff">&lt;/span> LDFLAGS&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;-lcrypto&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>And finally, you just need to:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">make
&lt;span style="color:#75715e"># May require root permissions&lt;/span>
make install
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="setup-with-ecto">Setup with Ecto&lt;/h2>
&lt;p>Right before this post went live, I submitted two PRs to the Elixir SQLite driver:&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://github.com/elixir-sqlite/exqlite/pull/186">https://github.com/elixir-sqlite/exqlite/pull/186&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/elixir-sqlite/exqlite/pull/187">https://github.com/elixir-sqlite/exqlite/pull/187&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>The first allows for using externally compiled SQLite engine. This is required to use our
previously compiled SQLCipher engine.&lt;/p>
&lt;p>The second allows for setting the &lt;code>KEY&lt;/code> PRAGMA value. This is what SQLite SEE and SQLCipher
both use to decrypt data. It must be supplied before &lt;em>any&lt;/em> of the SQLite database will be
accessable.&lt;/p>
&lt;p>To have access to these new features, you will need to update to the latest version of &lt;code>exqlite&lt;/code>.
Add &lt;code>{:exqlite &amp;quot;~&amp;gt; 0.9&amp;quot;}&lt;/code> to your project, or simply update it with:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">mix deps.update exqlite
&lt;/code>&lt;/pre>&lt;/div>&lt;p>To get &lt;code>exqlite&lt;/code> to use our SQLCipher installation, you need to export a handful of environment variables:&lt;/p>
&lt;pre tabindex="0">&lt;code># tell exqlite that we wish to use some other sqlite installation. this will prevent sqlite3.c and friends from compiling
export EXQLITE_USE_SYSTEM=1
# Tell exqlite where to find the `sqlite3.h` file
export EXQLITE_SYSTEM_CFLAGS=-I/usr/local/include/sqlcipher
# tell exqlite which sqlite implementation to use
export EXQLITE_SYSTEM_LDFLAGS=-L/usr/local/lib -lsqlcipher
&lt;/code>&lt;/pre>&lt;p>do a recompile with:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">mix deps.compile exqlite --force
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Almost done, the only other thing you have to do is supply a &lt;code>key&lt;/code> to the config. In &lt;code>config.exs&lt;/code> you can do something like:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-elixir" data-lang="elixir">config &lt;span style="color:#e6db74">:my_app&lt;/span>,
&lt;span style="color:#e6db74">ecto_repos&lt;/span>: [&lt;span style="color:#a6e22e">MyApp.Repo&lt;/span>]
config &lt;span style="color:#e6db74">:my_app&lt;/span>, &lt;span style="color:#a6e22e">MyApp.Repo&lt;/span>,
&lt;span style="color:#e6db74">database&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;path/to/my/database.db&amp;#34;&lt;/span>,
&lt;span style="color:#e6db74">key&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;test123&amp;#34;&lt;/span> &lt;span style="color:#75715e"># add this line&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>And that&amp;rsquo;s it! Your data is now encrypted using the key provided.&lt;/p></content></item></channel></rss>