<!doctype html><html lang=en><head><title>Using HX711 with Linux :: cone.codes</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="DeviceTree configuration and setup for Linux HX711"><meta name=keywords content="linux"><meta name=robots content="noodp"><link rel=canonical href=https://cone.codes/posts/linux-hx711/><link rel=stylesheet href=https://cone.codes/assets/style.css><link rel=stylesheet href=https://cone.codes/assets/pink.css><link rel=apple-touch-icon href=https://cone.codes/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://cone.codes/img/favicon/pink.png><meta name=twitter:card content="summary"><meta name=twitter:site content="https://connorrigby.github.io/connorrigby/"><meta name=twitter:creator content="PressY4Pie"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Using HX711 with Linux"><meta property="og:description" content="DeviceTree configuration and setup for Linux HX711"><meta property="og:url" content="https://cone.codes/posts/linux-hx711/"><meta property="og:site_name" content="cone.codes"><meta property="og:image" content="https://cone.codes/img/favicon/pink.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2022-01-20 16:24:27 -0700 -0700"></head><body class=pink><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>cone.codes</div></a></div></div></header><div class=content><div class=post><h1 class=post-title><a href=https://cone.codes/posts/linux-hx711/>Using HX711 with Linux</a></h1><div class=post-meta><span class=post-date>2022-01-20</span>
<span class=post-author>:: Connor Rigby</span></div><span class=post-tags>#<a href=https://cone.codes/tags/embedded/>embedded</a>&nbsp;
#<a href=https://cone.codes/tags/linux/>linux</a>&nbsp;</span><div class=post-content><div><h1 id=tldr>TLDR<a href=#tldr class=hanchor arialabel=Anchor>&#8983;</a></h1><p>Here&rsquo;s the code you probably want. Modify it as you see fit.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>loadcell_en_reg: fixedregulator<span style=color:#960050;background-color:#1e0010>@</span><span style=color:#ae81ff>3</span> {
</span></span><span style=display:flex><span>  compatible <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;regulator-fixed&#34;</span>;
</span></span><span style=display:flex><span>  regulator<span style=color:#f92672>-</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;loadcell-en-regulator&#34;</span>;
</span></span><span style=display:flex><span>  regulator<span style=color:#f92672>-</span>min<span style=color:#f92672>-</span>microvolt <span style=color:#f92672>=</span> <span style=color:#f92672>&lt;</span><span style=color:#ae81ff>3300000</span><span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>  regulator<span style=color:#f92672>-</span>max<span style=color:#f92672>-</span>microvolt <span style=color:#f92672>=</span> <span style=color:#f92672>&lt;</span><span style=color:#ae81ff>3300000</span><span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* ADC_PWR_EN */</span>
</span></span><span style=display:flex><span>  gpio <span style=color:#f92672>=</span> <span style=color:#f92672>&lt;&amp;</span>gpio1 <span style=color:#ae81ff>13</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>  enable<span style=color:#f92672>-</span>active<span style=color:#f92672>-</span>high;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>hx711: hx711 {
</span></span><span style=display:flex><span>  compatible <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;avia,hx711&#34;</span>;
</span></span><span style=display:flex><span>  sck<span style=color:#f92672>-</span>gpios <span style=color:#f92672>=</span> <span style=color:#f92672>&lt;&amp;</span>gpio1 <span style=color:#ae81ff>14</span> GPIO_ACTIVE_HIGH<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>  dout<span style=color:#f92672>-</span>gpios <span style=color:#f92672>=</span> <span style=color:#f92672>&lt;&amp;</span>gpio1 <span style=color:#ae81ff>15</span> GPIO_ACTIVE_HIGH<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>  avdd<span style=color:#f92672>-</span>supply <span style=color:#f92672>=</span> <span style=color:#f92672>&lt;&amp;</span>loadcell_en_reg<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat /sys/bus/iio/devices/iio:device2/in_voltage0_raw
</span></span><span style=display:flex><span><span style=color:#ae81ff>6818404</span>
</span></span></code></pre></div><h1 id=using-hx711-from-linux>Using HX711 from Linux<a href=#using-hx711-from-linux class=hanchor arialabel=Anchor>&#8983;</a></h1><p>The HX711 is a really common device, most commonly used to
measure weight via a load cell. It uses a simple 2 wire interface
with a clock and signal. It&rsquo;s not a standard protocol, but simple
anyway.</p><p>You can find devboards at <a href=https://www.sparkfun.com/products/13879>SparkFun</a>.
You will also probably need a load cell, which can also be found
at <a href=https://www.sparkfun.com/products/13329>SparkFun</a>.</p><p>There are a ton of implementations out there for using this particular
device:</p><ul><li><a href=https://www.arduino.cc/reference/en/libraries/hx711-arduino-library/>Arduino</a></li><li><a href=https://github.com/tatobari/hx711py>Python</a></li><li><a href=https://www.npmjs.com/package/hx711>Javscript</a></li></ul><p>But for embedded Linux, none of these are particulary suitable.
Luckily, there is a Linux Kernel Module available for that use
case. <a href=https://github.com/torvalds/linux/blob/master/drivers/iio/adc/hx711.c>Source</a></p><p>Unfortunately, as is common with these sorts of devices in Linux, there is almost
no documentation for it besides the
<a href=https://lore.kernel.org/lkml/20170105175156.GA12221@andreas/>Kernel patch&rsquo;s original submission</a>
and a small blurb in the <a href=https://elixir.bootlin.com/linux/v5.1-rc5/source/Documentation/devicetree/bindings/iio/adc/avia-hx711.txt>Device Tree</a>.</p><p>By the way, there&rsquo;s a typo in the above document. Don&rsquo;t spend an entire work day
figuring that out like me.</p><h2 id=enable-the-kernel-module>Enable the Kernel Module<a href=#enable-the-kernel-module class=hanchor arialabel=Anchor>&#8983;</a></h2><p>To use this device with Linux, the first thing you will need to do is enable the
kernel module. The name of the module is <code>CONFIG_HX711</code>. You can enable it
in the <code>make menuconfig</code> menu. Use <code>/</code> to search for it.</p><h2 id=configure-the-device-tree>Configure the Device Tree<a href=#configure-the-device-tree class=hanchor arialabel=Anchor>&#8983;</a></h2><p>This is the hardest part for me to getting this device working was setting up the
Device tree. The first section has the code required, but I&rsquo;ll walk thru the parts
that held me up.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>  avdd<span style=color:#f92672>-</span>supply <span style=color:#f92672>=</span> <span style=color:#f92672>&lt;&amp;</span>loadcell_en_reg<span style=color:#f92672>&gt;</span>;
</span></span></code></pre></div><p>This was probably the single most time consuming part of the entire project. In my particular
case, the regulator is external too my system regulator.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>loadcell_en_reg: fixedregulator<span style=color:#960050;background-color:#1e0010>@</span><span style=color:#ae81ff>3</span> {
</span></span><span style=display:flex><span>  compatible <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;regulator-fixed&#34;</span>;
</span></span><span style=display:flex><span>  regulator<span style=color:#f92672>-</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;loadcell-en-regulator&#34;</span>;
</span></span><span style=display:flex><span>  regulator<span style=color:#f92672>-</span>min<span style=color:#f92672>-</span>microvolt <span style=color:#f92672>=</span> <span style=color:#f92672>&lt;</span><span style=color:#ae81ff>3300000</span><span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>  regulator<span style=color:#f92672>-</span>max<span style=color:#f92672>-</span>microvolt <span style=color:#f92672>=</span> <span style=color:#f92672>&lt;</span><span style=color:#ae81ff>3300000</span><span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>/* ADC_PWR_EN */</span>
</span></span><span style=display:flex><span>  gpio <span style=color:#f92672>=</span> <span style=color:#f92672>&lt;&amp;</span>gpio1 <span style=color:#ae81ff>13</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>  enable<span style=color:#f92672>-</span>active<span style=color:#f92672>-</span>high;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>This looks pretty simple now that I know what everything does. The trick was finding out
I needed a <code>regulator-fixed</code> device. I spent a lot of time trying to get a different node
functioning: <a href=https://www.kernel.org/doc/Documentation/devicetree/bindings/regulator/gpio-regulator.txt>regulator-gpio</a>.
My thought process being</p><blockquote><p>I have a regulator, it&rsquo;s enabled by gpio, therefor I must want <code>gpio regulator</code>.</p></blockquote><p>This turned out to be false, and <code>regulator-fixed</code> itself actually supports using
<code>gpio</code> to enable it.</p><h2 id=getting-data-from-the-hx711>Getting Data from the HX711<a href=#getting-data-from-the-hx711 class=hanchor arialabel=Anchor>&#8983;</a></h2><p>The module uses the <a href=https://www.kernel.org/doc/html/v5.4/driver-api/iio/index.html><code>iio</code></a>
subsystem. That document was a little overwealming to me, so here&rsquo;s the cheat codes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/sys/bus/iio/devices/iio:device2/in_voltage0_raw
</span></span></code></pre></div><h2 id=calibration>Calibration<a href=#calibration class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Read that file, it will give you the voltage from the device. This value will need
to be calibrated in userspace as documented by the original author of the driver.
This varries depending on which load cell you have and how your device is positioned in
the real world. I may update this post in the future with how i calibrate the device, for
now you probably want to consult the <a href=https://cdn.sparkfun.com/assets/learn_tutorials/5/4/6/hx711F_EN.pdf>Datasheet</a>.</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://cone.codes/posts/encrypted-sqlite-with-ecto/><span class=button__icon>←</span>
<span class=button__text>Encrypted SQLite With Ecto</span></a></span>
<span class="button next"><a href=https://cone.codes/posts/iex-in-a-box/><span class=button__text>IEx in a Box</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>Creative Commons Attribution 4.0 International</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://cone.codes/assets/main.js></script>
<script src=https://cone.codes/assets/prism.js></script></div></body></html>