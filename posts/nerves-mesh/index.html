<!doctype html><html lang=en><head><title>Creating mesh networks with Nerves :: cone.codes</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Erlang Distribution over 802.11s mesh network"><meta name=keywords content="linux,elixir,nerves"><meta name=robots content="noodp"><link rel=canonical href=https://cone.codes/posts/nerves-mesh/><script async src="https://www.googletagmanager.com/gtag/js?id=G-232FYPH9EF"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-232FYPH9EF",{anonymize_ip:!1})}</script><link rel=stylesheet href=https://cone.codes/assets/style.css><link rel=stylesheet href=https://cone.codes/assets/pink.css><link rel=apple-touch-icon href=https://cone.codes/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://cone.codes/img/favicon/pink.png><meta name=twitter:card content="summary"><meta name=twitter:site content="https://connorrigby.github.io/connorrigby/"><meta name=twitter:creator content="PressY4Pie"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Creating mesh networks with Nerves"><meta property="og:description" content="Erlang Distribution over 802.11s mesh network"><meta property="og:url" content="https://cone.codes/posts/nerves-mesh/"><meta property="og:site_name" content="cone.codes"><meta property="og:image" content="https://cone.codes/nerves-mesh/pcbs.webp"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2024-03-25 17:36:33 -0600 -0600"></head><body class=pink><div class="container full headings--one-size"><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-232FYPH9EF"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-232FYPH9EF",{anonymize_ip:!1})}</script><script>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-232FYPH9EF","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><div class=content><div class=post><h1 class=post-title><a href=https://cone.codes/posts/nerves-mesh/>Creating mesh networks with Nerves</a></h1><div class=post-meta><span class=post-date>2024-03-25
</span><span class=post-author>:: Connor Rigby</span></div><span class=post-tags>#<a href=https://cone.codes/tags/elixir/>elixir</a>&nbsp;
#<a href=https://cone.codes/tags/nerves/>nerves</a>&nbsp;
#<a href=https://cone.codes/tags/embedded-linux/>embedded linux</a>&nbsp;
#<a href=https://cone.codes/tags/linux/>linux</a>&nbsp;
</span><img src=https://cone.codes/nerves-mesh/pcbs.webp class=post-cover alt="Creating mesh networks with Nerves" title="Cover Image"><div class=post-content><div><h2 id=tldr>TLDR<a href=#tldr class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Here&rsquo;s the sample code. read on to get a breakdown.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span><span style=color:#66d9ef>defmodule</span> <span style=color:#a6e22e>MyAppFw.Mesh</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>require</span> <span style=color:#a6e22e>Logger</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> start_link <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>GenServer</span><span style=color:#f92672>.</span>start_link(__MODULE__, [], <span style=color:#e6db74>name</span>: __MODULE__)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> init(_args) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>VintageNet</span><span style=color:#f92672>.</span>subscribe([<span style=color:#e6db74>&#34;interface&#34;</span>, <span style=color:#e6db74>&#34;mesh0&#34;</span>])
</span></span><span style=display:flex><span>    {<span style=color:#e6db74>:ok</span>, %{<span style=color:#e6db74>socket</span>: <span style=color:#66d9ef>nil</span>, <span style=color:#e6db74>select</span>: <span style=color:#66d9ef>nil</span>, <span style=color:#e6db74>node</span>: <span style=color:#66d9ef>nil</span>}, {<span style=color:#e6db74>:continue</span>, <span style=color:#e6db74>:init_mesh</span>}}
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> terminate(_, state) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>Node</span><span style=color:#f92672>.</span>alive? <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>for</span> node <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>Node</span><span style=color:#f92672>.</span>list(), <span style=color:#e6db74>do</span>: <span style=color:#a6e22e>Node</span><span style=color:#f92672>.</span>disconnect(node)
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Node</span><span style=color:#f92672>.</span>stop()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> state<span style=color:#f92672>.</span>socket, <span style=color:#e6db74>do</span>: <span style=color:#e6db74>:socket</span><span style=color:#f92672>.</span>close(state<span style=color:#f92672>.</span>socket)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>VintageNet</span><span style=color:#f92672>.</span>reset_to_defaults(<span style=color:#e6db74>&#34;mesh0&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> handle_continue(<span style=color:#e6db74>:init_mesh</span>, state) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>:os</span><span style=color:#f92672>.</span>cmd(<span style=color:#e6db74>&#39;ip link set wlan0 down&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>VintageNet</span><span style=color:#f92672>.</span>configure(<span style=color:#e6db74>&#34;mesh0&#34;</span>, %{
</span></span><span style=display:flex><span>      <span style=color:#e6db74>type</span>: <span style=color:#a6e22e>VintageNetWiFi</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>ipv4</span>: %{<span style=color:#e6db74>method</span>: <span style=color:#e6db74>:disabled</span>},
</span></span><span style=display:flex><span>      <span style=color:#e6db74>vintage_net_wifi</span>: %{
</span></span><span style=display:flex><span>        <span style=color:#e6db74>root_interface</span>: <span style=color:#e6db74>&#34;wlan0&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>user_mpm</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>networks</span>: [
</span></span><span style=display:flex><span>          %{
</span></span><span style=display:flex><span>            <span style=color:#e6db74>ssid</span>: <span style=color:#e6db74>&#34;myapp&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>key_mgmt</span>: <span style=color:#e6db74>:none</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>mode</span>: <span style=color:#e6db74>:mesh</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>frequency</span>: <span style=color:#ae81ff>2412</span>,
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }, <span style=color:#e6db74>persist</span>: <span style=color:#66d9ef>false</span>)
</span></span><span style=display:flex><span>    {<span style=color:#e6db74>:noreply</span>, state}
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> handle_continue(<span style=color:#e6db74>:recvfrom</span>, state) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>:socket</span><span style=color:#f92672>.</span>recvfrom(state<span style=color:#f92672>.</span>socket, [], <span style=color:#e6db74>:nowait</span>) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>      {<span style=color:#e6db74>:select</span>, {<span style=color:#e6db74>:select_info</span>, _tag, select}} <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Logger</span><span style=color:#f92672>.</span>info(%{<span style=color:#e6db74>select</span>: select})
</span></span><span style=display:flex><span>        {<span style=color:#e6db74>:noreply</span>, %{state <span style=color:#f92672>|</span> <span style=color:#e6db74>select</span>: select}}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      {<span style=color:#e6db74>:ok</span>, {source, data}} <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Logger</span><span style=color:#f92672>.</span>info(%{<span style=color:#e6db74>source</span>: source, <span style=color:#e6db74>data</span>: data})
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#e6db74>:inet</span><span style=color:#f92672>.</span>parse_ipv6_address(<span style=color:#a6e22e>String</span><span style=color:#f92672>.</span>to_charlist(data)) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>          {<span style=color:#e6db74>:ok</span>, _addr} <span style=color:#f92672>-&gt;</span> 
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#e6db74>:&#34;myapp@</span><span style=color:#e6db74>#{</span>data<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> <span style=color:#a6e22e>Node</span><span style=color:#f92672>.</span>list() <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>Logger</span><span style=color:#f92672>.</span>info(%{<span style=color:#e6db74>connecting_node</span>: <span style=color:#e6db74>:&#34;myapp@</span><span style=color:#e6db74>#{</span>data<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>})
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>Node</span><span style=color:#f92672>.</span>connect(<span style=color:#e6db74>:&#34;myapp@</span><span style=color:#e6db74>#{</span>data<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>Logger</span><span style=color:#f92672>.</span>info(%{<span style=color:#e6db74>already_connected</span>: <span style=color:#e6db74>:&#34;myapp@</span><span style=color:#e6db74>#{</span>data<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>})
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>          data <span style=color:#f92672>-&gt;</span> 
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Logger</span><span style=color:#f92672>.</span>warning(%{<span style=color:#e6db74>unknown_data</span>: data}) 
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>        {<span style=color:#e6db74>:noreply</span>, state, {<span style=color:#e6db74>:continue</span>, <span style=color:#e6db74>:recvfrom</span>}}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> handle_continue(<span style=color:#e6db74>:sendto</span>, state) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;AH&#34;</span> <span style=color:#f92672>&lt;&gt;</span> id <span style=color:#f92672>=</span> <span style=color:#a6e22e>Nerves.Runtime</span><span style=color:#f92672>.</span>serial_number
</span></span><span style=display:flex><span>    &lt;&lt;_<span style=color:#f92672>::</span>binary<span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>, serial<span style=color:#f92672>::</span>binary<span style=color:#f92672>-</span><span style=color:#ae81ff>6</span>, _<span style=color:#f92672>::</span>binary<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>&gt;&gt; <span style=color:#f92672>=</span> <span style=color:#a6e22e>Base</span><span style=color:#f92672>.</span>decode16!(id)
</span></span><span style=display:flex><span>    addr_sufix <span style=color:#f92672>=</span> <span style=color:#a6e22e>Base</span><span style=color:#f92672>.</span>encode16(serial, <span style=color:#e6db74>case</span>: <span style=color:#e6db74>:lower</span>)  <span style=color:#f92672>|&gt;</span> <span style=color:#a6e22e>String</span><span style=color:#f92672>.</span>to_charlist() <span style=color:#f92672>|&gt;</span> <span style=color:#a6e22e>Enum</span><span style=color:#f92672>.</span>chunk_every(<span style=color:#ae81ff>4</span>) <span style=color:#f92672>|&gt;</span> <span style=color:#a6e22e>Enum</span><span style=color:#f92672>.</span>join(<span style=color:#e6db74>&#34;:&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>:socket</span><span style=color:#f92672>.</span>sendto(state<span style=color:#f92672>.</span>socket, <span style=color:#e6db74>&#34;fd12:3456:789a:1::</span><span style=color:#e6db74>#{</span>addr_sufix<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>, %{<span style=color:#e6db74>family</span>: <span style=color:#e6db74>:inet6</span>, <span style=color:#e6db74>port</span>: <span style=color:#ae81ff>49999</span>, <span style=color:#e6db74>addr</span>: {<span style=color:#ae81ff>0xFF02</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0x69</span>}}) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>:ok</span> <span style=color:#f92672>-&gt;</span> {<span style=color:#e6db74>:noreply</span>, state}
</span></span><span style=display:flex><span>      {<span style=color:#e6db74>:error</span>, reason} <span style=color:#f92672>-&gt;</span> 
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Logger</span><span style=color:#f92672>.</span>error(%{<span style=color:#e6db74>sendto</span>: reason})
</span></span><span style=display:flex><span>        {<span style=color:#e6db74>:noreply</span>, state, {<span style=color:#e6db74>:continue</span>, <span style=color:#e6db74>:sendto</span>}}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> handle_info({<span style=color:#e6db74>:&#34;$socket&#34;</span>, socket, <span style=color:#e6db74>:select</span>, select}, %{<span style=color:#e6db74>socket</span>: socket, <span style=color:#e6db74>select</span>: select} <span style=color:#f92672>=</span> state) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Logger</span><span style=color:#f92672>.</span>info(%{<span style=color:#e6db74>select</span>: select})
</span></span><span style=display:flex><span>    {<span style=color:#e6db74>:noreply</span>, %{state <span style=color:#f92672>|</span> <span style=color:#e6db74>select</span>: <span style=color:#66d9ef>nil</span>}, {<span style=color:#e6db74>:continue</span>, <span style=color:#e6db74>:recvfrom</span>}}
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> handle_info({<span style=color:#a6e22e>VintageNet</span>, [<span style=color:#e6db74>&#34;interface&#34;</span>, <span style=color:#e6db74>&#34;mesh0&#34;</span>, <span style=color:#e6db74>&#34;wifi&#34;</span>, <span style=color:#e6db74>&#34;peers&#34;</span>], _old, new, _}, state) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Logger</span><span style=color:#f92672>.</span>info(%{<span style=color:#e6db74>peers</span>: new, <span style=color:#e6db74>socket</span>: state<span style=color:#f92672>.</span>socket})
</span></span><span style=display:flex><span>    {<span style=color:#e6db74>:noreply</span>, state, {<span style=color:#e6db74>:continue</span>, <span style=color:#e6db74>:sendto</span>}}
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> handle_info({<span style=color:#a6e22e>VintageNet</span>, [<span style=color:#e6db74>&#34;interface&#34;</span>, <span style=color:#e6db74>&#34;mesh0&#34;</span>, <span style=color:#e6db74>&#34;lower_up&#34;</span>], <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>true</span>, _}, state) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;AH&#34;</span> <span style=color:#f92672>&lt;&gt;</span> id <span style=color:#f92672>=</span> <span style=color:#a6e22e>Nerves.Runtime</span><span style=color:#f92672>.</span>serial_number
</span></span><span style=display:flex><span>    &lt;&lt;_<span style=color:#f92672>::</span>binary<span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>, serial<span style=color:#f92672>::</span>binary<span style=color:#f92672>-</span><span style=color:#ae81ff>6</span>, _<span style=color:#f92672>::</span>binary<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>&gt;&gt; <span style=color:#f92672>=</span> <span style=color:#a6e22e>Base</span><span style=color:#f92672>.</span>decode16!(id)
</span></span><span style=display:flex><span>    addr_sufix <span style=color:#f92672>=</span> <span style=color:#a6e22e>Base</span><span style=color:#f92672>.</span>encode16(serial, <span style=color:#e6db74>case</span>: <span style=color:#e6db74>:lower</span>)  <span style=color:#f92672>|&gt;</span> <span style=color:#a6e22e>String</span><span style=color:#f92672>.</span>to_charlist() <span style=color:#f92672>|&gt;</span> <span style=color:#a6e22e>Enum</span><span style=color:#f92672>.</span>chunk_every(<span style=color:#ae81ff>4</span>) <span style=color:#f92672>|&gt;</span> <span style=color:#a6e22e>Enum</span><span style=color:#f92672>.</span>join(<span style=color:#e6db74>&#34;:&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#e6db74>:os</span><span style=color:#f92672>.</span>cmd(<span style=color:#e6db74>&#39;ip addr add fd12:3456:789a:1::</span><span style=color:#e6db74>#{</span>addr_sufix<span style=color:#e6db74>}</span><span style=color:#e6db74>/48 dev mesh0&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    {<span style=color:#e6db74>:ok</span>, socket} <span style=color:#f92672>=</span> <span style=color:#e6db74>:socket</span><span style=color:#f92672>.</span>open(<span style=color:#e6db74>:inet6</span>, <span style=color:#e6db74>:dgram</span>, <span style=color:#e6db74>:udp</span>)
</span></span><span style=display:flex><span>    <span style=color:#e6db74>:ok</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>:socket</span><span style=color:#f92672>.</span>setopt(socket, <span style=color:#e6db74>:socket</span>, <span style=color:#e6db74>:bindtodevice</span>, <span style=color:#e6db74>&#39;mesh0&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#e6db74>:ok</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>:socket</span><span style=color:#f92672>.</span>setopt(socket, <span style=color:#e6db74>:socket</span>, <span style=color:#e6db74>:reuseport</span>, <span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>    <span style=color:#e6db74>:ok</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>:socket</span><span style=color:#f92672>.</span>setopt(socket, <span style=color:#e6db74>:socket</span>, <span style=color:#e6db74>:reuseaddr</span>, <span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>    <span style=color:#e6db74>:ok</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>:socket</span><span style=color:#f92672>.</span>setopt(socket, <span style=color:#e6db74>:ipv6</span>, <span style=color:#e6db74>:multicast_loop</span>, <span style=color:#66d9ef>false</span>)
</span></span><span style=display:flex><span>    <span style=color:#e6db74>:ok</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>:socket</span><span style=color:#f92672>.</span>setopt(socket, <span style=color:#e6db74>:ipv6</span>, <span style=color:#e6db74>:multicast_hops</span>, <span style=color:#ae81ff>255</span>)
</span></span><span style=display:flex><span>    {<span style=color:#e6db74>:ok</span>, interface} <span style=color:#f92672>=</span> <span style=color:#e6db74>:net</span><span style=color:#f92672>.</span>if_name2index(<span style=color:#e6db74>&#39;mesh0&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#e6db74>:ok</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>:socket</span><span style=color:#f92672>.</span>setopt(socket, <span style=color:#e6db74>:ipv6</span>, <span style=color:#e6db74>:multicast_if</span>, interface)
</span></span><span style=display:flex><span>    <span style=color:#e6db74>:ok</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>:socket</span><span style=color:#f92672>.</span>bind(socket, %{<span style=color:#e6db74>family</span>: <span style=color:#e6db74>:inet6</span>, <span style=color:#e6db74>port</span>: <span style=color:#ae81ff>49999</span>})
</span></span><span style=display:flex><span>    <span style=color:#e6db74>:ok</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>:socket</span><span style=color:#f92672>.</span>setopt(socket, <span style=color:#e6db74>:ipv6</span>, <span style=color:#e6db74>:add_membership</span>, %{
</span></span><span style=display:flex><span>        <span style=color:#e6db74>multiaddr</span>: {<span style=color:#ae81ff>0xFF02</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0x69</span>},
</span></span><span style=display:flex><span>        <span style=color:#e6db74>interface</span>: interface
</span></span><span style=display:flex><span>      })
</span></span><span style=display:flex><span>    {<span style=color:#e6db74>:ok</span>, node} <span style=color:#f92672>=</span> <span style=color:#a6e22e>Node</span><span style=color:#f92672>.</span>start(<span style=color:#e6db74>:&#34;myapp@fd12:3456:789a:1::</span><span style=color:#e6db74>#{</span>addr_sufix<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Node</span><span style=color:#f92672>.</span>set_cookie(<span style=color:#e6db74>:democookie</span>)
</span></span><span style=display:flex><span>    {<span style=color:#e6db74>:noreply</span>, %{state <span style=color:#f92672>|</span> <span style=color:#e6db74>socket</span>: socket, <span style=color:#e6db74>node</span>: node}, {<span style=color:#e6db74>:continue</span>, <span style=color:#e6db74>:recvfrom</span>}}
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> handle_info({<span style=color:#a6e22e>VintageNet</span>, _, _, _, _}, state) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    {<span style=color:#e6db74>:noreply</span>, state}
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><h2 id=building-a-erlang-distribution-cluster-over-a-80211s-mesh-network>Building a Erlang Distribution Cluster Over a 802.11s Mesh Network<a href=#building-a-erlang-distribution-cluster-over-a-80211s-mesh-network class=hanchor arialabel=Anchor>&#8983;</a></h2><ul><li>The goal: <a href=https://www.erlang.org/doc/reference_manual/distributed.html>Distributed Erlang</a></li><li>The network: <a href=https://en.wikipedia.org/wiki/IEEE_802.11s>802.11s Mesh</a></li><li>The IP Addresses: <a href=https://en.wikipedia.org/wiki/IPv6>V6</a></li></ul><h2 id=required-hardware>Required Hardware<a href=#required-hardware class=hanchor arialabel=Anchor>&#8983;</a></h2><p>There are two specific pieces of hardware used in this project. These two parts are required, but should generally be applicable to any Nerves device with support for them. (most).</p><h3 id=80211s-compatible-wifi>802.11S Compatible WiFi<a href=#80211s-compatible-wifi class=hanchor arialabel=Anchor>&#8983;</a></h3><p>This isn&rsquo;t a <em>new</em> standard by any means, but it&rsquo;s not an old one either. Support for it exists in modern Linux kernel and userspace applications, but drivers often don&rsquo;t implement it for one reason or another, or the hardware
simply does not support it. I found a lovely list of compatible devices at <a href=https://github.com/phillymesh/802.11s-adapters>phillymesh/802.11s-adapters</a>. As seen in the cover photo, I&rsquo;m using unbranded &ldquo;802.11n&rdquo; marked WiFi dongles that support it.</p><h3 id=atecc508aatecc608a-crypto-module>ATECC508A/ATECC608A Crypto Module<a href=#atecc508aatecc608a-crypto-module class=hanchor arialabel=Anchor>&#8983;</a></h3><p>This isn&rsquo;t actually <strong>required</strong>, it just solves a complicated problem of creating unique id numbers. The ATECC608A chip is responsible for providing a 48 unique serial number that we are going to use as a way of identifying nodes on the network.
This is a wide problem space with many solutions. This is just <em>one</em> of them.</p><h2 id=package-setup>Package Setup<a href=#package-setup class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Not much code needs to be written from scratch here. We&rsquo;re mostly gluing pieces together. The first pieces we&rsquo;ll look at is <a href=https://github.com/nerves-networking/vintage_net>VintageNet</a> and <a href=https://github.com/nerves-networking/vintage_net_wifi>VintageNetWiFi</a>.
These two libraries are going to be responsible for creating and managing the physical network.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span>    <span style=color:#a6e22e>VintageNet</span><span style=color:#f92672>.</span>configure(<span style=color:#e6db74>&#34;mesh0&#34;</span>, %{
</span></span><span style=display:flex><span>      <span style=color:#e6db74>type</span>: <span style=color:#a6e22e>VintageNetWiFi</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>ipv4</span>: %{<span style=color:#e6db74>method</span>: <span style=color:#e6db74>:disabled</span>},
</span></span><span style=display:flex><span>      <span style=color:#e6db74>vintage_net_wifi</span>: %{
</span></span><span style=display:flex><span>        <span style=color:#e6db74>root_interface</span>: <span style=color:#e6db74>&#34;wlan0&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>user_mpm</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>networks</span>: [
</span></span><span style=display:flex><span>          %{
</span></span><span style=display:flex><span>            <span style=color:#e6db74>ssid</span>: <span style=color:#e6db74>&#34;myapp&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>key_mgmt</span>: <span style=color:#e6db74>:none</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>mode</span>: <span style=color:#e6db74>:mesh</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>frequency</span>: <span style=color:#ae81ff>2412</span>,
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }, <span style=color:#e6db74>persist</span>: <span style=color:#66d9ef>false</span>)
</span></span></code></pre></div><p>This configures the root_interface <code>wlan0</code>, which in my case happens to be a USB WiFi dongle into <code>:mesh</code> mode. <code>ipv4</code> is disabled. We&rsquo;ll see why in just a second. We also set <code>persist: false</code> to prevent VintageNet from saving this config and applying it at boot.
The reason for that is because internally, when the kernel registers the <code>mesh0</code> interface, the order in which we bring the interface up is important. We want to first bring <code>wlan0</code> down:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span><span style=color:#e6db74>:os</span><span style=color:#f92672>.</span>cmd(<span style=color:#e6db74>&#39;ip link set wlan0 down&#39;</span>)
</span></span></code></pre></div><p>then configure the mesh interface using the above <code>configure/3</code> command which will internally call <code>:os.cmd('ip link set mesh0 up')</code> and kick off the internal state management and <code>wpa_supplicant</code>. With just these two commands, the mesh is now running.
When we run those two commands on two different nodes, we can check the current network with something like this at the IEX console:</p><pre tabindex=0><code>iex()1&gt; cmd(&#34;iw dev mesh0 station dump&#34;)
Station 1c:bf:ce:17:1d:7a (on mesh0)
        inactive time:  770 ms
        rx bytes:       2112019
        rx packets:     30557
        tx bytes:       280280
        tx packets:     2789
        tx retries:     158
        tx failed:      3
        rx drop misc:   15
        signal:         -35 dBm
        signal avg:     -35 dBm
        Toffset:        18446744073682909240 us
        tx bitrate:     72.2 MBit/s MCS 7 short GI
        tx duration:    0 us
        rx bitrate:     72.2 MBit/s MCS 7 short GI
        rx duration:    0 us
        expected throughput:    32.134Mbps
        mesh llid:      0
        mesh plid:      0
        mesh plink:     ESTAB
        mesh airtime link metric: 249
        mesh connected to gate: no
        mesh connected to auth server:  no
        mesh local PS mode:     ACTIVE
        mesh peer PS mode:      ACTIVE
        mesh non-peer PS mode:  ACTIVE
        authorized:     yes
        authenticated:  yes
        associated:     yes
        preamble:       long
        WMM/WME:        yes
        MFP:            no
        TDLS peer:      no
        DTIM period:    2
        beacon interval:1000
        connected time: 13770 seconds
        associated at [boottime]:       15037.896s
        associated at:  1711397904710 ms
        current time:   1711411674604 ms
</code></pre><p>Now this is great, but there&rsquo;s no way currently to communicate between these nodes. To make that happen, we <strong>COULD</strong> try to come up with some algorithm to attempt to request an IP address from a DHCP server, if there isn&rsquo;t one available start it etc etc. Or even run
an <code>mdns</code> server and client on both devices, and attempt to discover eachother. But I&rsquo;ve employed what I think is a much neater solution that allows for discovery of other nodes without the need for a central authority on IP addresses.</p><p>This brings me to the other library we will use for this network: <a href=https://github.com/nerves-hub/nerves_key>NervesKey</a>. I&rsquo;ve already provisioned my keys, so I wont explain that here, but all I&rsquo;ve done for this setup is run the &ldquo;standard&rdquo; config as outlined in the README of the NervesKey repo.</p><p>This device communicates over the I2C bus. So to use the NervesKey library, we need to provide it with a <code>transport</code> of sorts telling the library where to find our key on the bus.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span>{<span style=color:#e6db74>:ok</span>, i2c} <span style=color:#f92672>=</span> <span style=color:#a6e22e>ATECC508A.Transport.I2C</span><span style=color:#f92672>.</span>init([<span style=color:#e6db74>bus_name</span>: <span style=color:#e6db74>&#34;i2c-0&#34;</span>])
</span></span></code></pre></div><p>This is where it is for my device. On Raspberry Pi for example, it&rsquo;s usually on <code>"i2c-1"</code> which is the default for the <code>init</code> function.</p><p>The ATECC chip can do a lot, but we only need one feature right now. the Device Serial number, and wwe get that with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span>iex(<span style=color:#ae81ff>2</span>)<span style=color:#f92672>&gt;</span> {<span style=color:#e6db74>:ok</span>, id} <span style=color:#f92672>=</span> <span style=color:#a6e22e>NervesKey.Config</span><span style=color:#f92672>.</span>device_sn(i2c)
</span></span><span style=display:flex><span>{<span style=color:#e6db74>:ok</span>, &lt;&lt;<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>35</span>, <span style=color:#ae81ff>111</span>, <span style=color:#ae81ff>68</span>, <span style=color:#ae81ff>227</span>, <span style=color:#ae81ff>198</span>, <span style=color:#ae81ff>184</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>238</span>&gt;&gt;}
</span></span></code></pre></div><p>Notice this id is in binary. We can turn it into something more readable with something like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span>iex(<span style=color:#ae81ff>3</span>)<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>Base</span><span style=color:#f92672>.</span>encode16(id, <span style=color:#e6db74>case</span>: <span style=color:#e6db74>:lower</span>)
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;01236f44e3c6b802ee&#34;</span>
</span></span></code></pre></div><p>There&rsquo;s actually a shortcut to the above operation that comes with Nerves.Runtime. We can use <code>Nerves.Runtime.serial_number</code> to do all the above stuff for us if configured correctly. Now all we need to do is create an IPV6 address
and assign it to our mesh0 interface and the two nodes should be able to communicate.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span><span style=color:#e6db74>&#34;AH&#34;</span> <span style=color:#f92672>&lt;&gt;</span> id <span style=color:#f92672>=</span> <span style=color:#a6e22e>Nerves.Runtime</span><span style=color:#f92672>.</span>serial_number
</span></span><span style=display:flex><span>&lt;&lt;_<span style=color:#f92672>::</span>binary<span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>, serial<span style=color:#f92672>::</span>binary<span style=color:#f92672>-</span><span style=color:#ae81ff>6</span>, _<span style=color:#f92672>::</span>binary<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>&gt;&gt; <span style=color:#f92672>=</span> <span style=color:#a6e22e>Base</span><span style=color:#f92672>.</span>decode16!(id) <span style=color:#75715e># isn&#39;t it funny I used the shortcut then changed it back into binary anyway?</span>
</span></span><span style=display:flex><span>addr_sufix <span style=color:#f92672>=</span> <span style=color:#a6e22e>Base</span><span style=color:#f92672>.</span>encode16(serial, <span style=color:#e6db74>case</span>: <span style=color:#e6db74>:lower</span>)  <span style=color:#f92672>|&gt;</span> <span style=color:#a6e22e>String</span><span style=color:#f92672>.</span>to_charlist() <span style=color:#f92672>|&gt;</span> <span style=color:#a6e22e>Enum</span><span style=color:#f92672>.</span>chunk_every(<span style=color:#ae81ff>4</span>) <span style=color:#f92672>|&gt;</span> <span style=color:#a6e22e>Enum</span><span style=color:#f92672>.</span>join(<span style=color:#e6db74>&#34;:&#34;</span>)
</span></span></code></pre></div><p>Here I take the serial number and trim off the <code>AH</code> &ldquo;header&rdquo; value. The first two bytes of the serial number encode the date manufacturing run of the device whose serial number is attached. These values are usually the same on this chip,
so we don&rsquo;t really want to use them for our IPV6 address. Similarly, the very last byte of the serial number encodes <strong>where</strong> the chip was made. This is almost always <code>0xEE</code> and again, we don&rsquo;t really want it in our IP address either.
This leaves 48 bits, or 6 bytes of values that will be unique for every device. Finally, I split that hex string every 4 characters and join by the <code>:</code> to lazily create the ID part of our ipv6 address. Now we just need to assign it to
the interface with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span><span style=color:#e6db74>:os</span><span style=color:#f92672>.</span>cmd(<span style=color:#e6db74>&#39;ip addr add fd12:3456:789a:1::</span><span style=color:#e6db74>#{</span>addr_sufix<span style=color:#e6db74>}</span><span style=color:#e6db74>/48 dev mesh0&#39;</span>)
</span></span></code></pre></div><p>Now our nodes can directly communicate with eachother:</p><pre tabindex=0><code>iex(1)&gt; cmd(&#34;ping fd12:3456:789a:1:0:6f44:e3c6:b802&#34;)
PING fd12:3456:789a:1:0:6f44:e3c6:b802 (fd12:3456:789a:1:0:6f44:e3c6:b802): 56 data bytes
64 bytes from fd12:3456:789a:1:0:6f44:e3c6:b802: seq=0 ttl=64 time=0.885 ms
64 bytes from fd12:3456:789a:1:0:6f44:e3c6:b802: seq=1 ttl=64 time=1.305 ms
64 bytes from fd12:3456:789a:1:0:6f44:e3c6:b802: seq=2 ttl=64 time=0.968 ms
</code></pre><p>And with direct communication, means we can setup Distributed Erlang:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span>iex(<span style=color:#ae81ff>1</span>)<span style=color:#f92672>&gt;</span> {<span style=color:#e6db74>:ok</span>, node} <span style=color:#f92672>=</span> <span style=color:#a6e22e>Node</span><span style=color:#f92672>.</span>start(<span style=color:#e6db74>:&#34;myapp@fd12:3456:789a:1::</span><span style=color:#e6db74>#{</span>addr_sufix<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>iex(myapp<span style=color:#a6e22e>@fd12</span>:<span style=color:#ae81ff>3456</span>:<span style=color:#ae81ff>789</span>a:<span style=color:#ae81ff>1</span><span style=color:#f92672>::</span><span style=color:#ae81ff>6</span>f44<span style=color:#e6db74>:e3c6:b802</span>)<span style=color:#ae81ff>2</span><span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>Node</span><span style=color:#f92672>.</span>set_cookie(<span style=color:#e6db74>:democookie</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>iex(myapp<span style=color:#a6e22e>@fd12</span>:<span style=color:#ae81ff>3456</span>:<span style=color:#ae81ff>789</span>a:<span style=color:#ae81ff>1</span><span style=color:#f92672>::</span><span style=color:#ae81ff>6</span>f44<span style=color:#e6db74>:e3c6:b802</span>)<span style=color:#ae81ff>3</span><span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>Node</span><span style=color:#f92672>.</span>list()
</span></span><span style=display:flex><span>[<span style=color:#e6db74>:&#34;myapp@fd12:3456:789a:1::e0f9:2f20:de47&#34;</span>]
</span></span></code></pre></div><p>The one final thing we need before we automate this whole process is a method to discover nodes on the network when we connect. I accomplished this with a very simple UDP socket on a multicast address to exchange information.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span>{<span style=color:#e6db74>:ok</span>, socket} <span style=color:#f92672>=</span> <span style=color:#e6db74>:socket</span><span style=color:#f92672>.</span>open(<span style=color:#e6db74>:inet6</span>, <span style=color:#e6db74>:dgram</span>, <span style=color:#e6db74>:udp</span>)
</span></span><span style=display:flex><span><span style=color:#e6db74>:ok</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>:socket</span><span style=color:#f92672>.</span>setopt(socket, <span style=color:#e6db74>:socket</span>, <span style=color:#e6db74>:bindtodevice</span>, <span style=color:#e6db74>&#39;mesh0&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#e6db74>:ok</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>:socket</span><span style=color:#f92672>.</span>setopt(socket, <span style=color:#e6db74>:socket</span>, <span style=color:#e6db74>:reuseport</span>, <span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span><span style=color:#e6db74>:ok</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>:socket</span><span style=color:#f92672>.</span>setopt(socket, <span style=color:#e6db74>:socket</span>, <span style=color:#e6db74>:reuseaddr</span>, <span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span><span style=color:#e6db74>:ok</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>:socket</span><span style=color:#f92672>.</span>setopt(socket, <span style=color:#e6db74>:ipv6</span>, <span style=color:#e6db74>:multicast_loop</span>, <span style=color:#66d9ef>false</span>)
</span></span><span style=display:flex><span><span style=color:#e6db74>:ok</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>:socket</span><span style=color:#f92672>.</span>setopt(socket, <span style=color:#e6db74>:ipv6</span>, <span style=color:#e6db74>:multicast_hops</span>, <span style=color:#ae81ff>255</span>)
</span></span><span style=display:flex><span>{<span style=color:#e6db74>:ok</span>, interface} <span style=color:#f92672>=</span> <span style=color:#e6db74>:net</span><span style=color:#f92672>.</span>if_name2index(<span style=color:#e6db74>&#39;mesh0&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#e6db74>:ok</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>:socket</span><span style=color:#f92672>.</span>setopt(socket, <span style=color:#e6db74>:ipv6</span>, <span style=color:#e6db74>:multicast_if</span>, interface)
</span></span><span style=display:flex><span><span style=color:#e6db74>:ok</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>:socket</span><span style=color:#f92672>.</span>bind(socket, %{<span style=color:#e6db74>family</span>: <span style=color:#e6db74>:inet6</span>, <span style=color:#e6db74>port</span>: <span style=color:#ae81ff>49999</span>})
</span></span><span style=display:flex><span><span style=color:#e6db74>:ok</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>:socket</span><span style=color:#f92672>.</span>setopt(socket, <span style=color:#e6db74>:ipv6</span>, <span style=color:#e6db74>:add_membership</span>, %{
</span></span><span style=display:flex><span>    <span style=color:#e6db74>multiaddr</span>: {<span style=color:#ae81ff>0xFF02</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0x69</span>},
</span></span><span style=display:flex><span>    <span style=color:#e6db74>interface</span>: interface
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span><span style=color:#e6db74>:socket</span><span style=color:#f92672>.</span>recvfrom(state<span style=color:#f92672>.</span>socket, [], <span style=color:#e6db74>:nowait</span>)
</span></span></code></pre></div><p>This creates a socket on <code>ff02::/8</code> and starts receiving packets on it. When we successfully join the mesh, we send our address on the socket with something like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span><span style=color:#e6db74>:socket</span><span style=color:#f92672>.</span>sendto(state<span style=color:#f92672>.</span>socket, <span style=color:#e6db74>&#34;fd12:3456:789a:1::</span><span style=color:#e6db74>#{</span>addr_sufix<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>, %{<span style=color:#e6db74>family</span>: <span style=color:#e6db74>:inet6</span>, <span style=color:#e6db74>port</span>: <span style=color:#ae81ff>49999</span>, <span style=color:#e6db74>addr</span>: {<span style=color:#ae81ff>0xFF02</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0x69</span>}})
</span></span></code></pre></div><p>When we receive this message on other nodes, attempt to connect to it like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#e6db74>:socket</span><span style=color:#f92672>.</span>recvfrom(state<span style=color:#f92672>.</span>socket, [], <span style=color:#e6db74>:nowait</span>) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    {<span style=color:#e6db74>:select</span>, {<span style=color:#e6db74>:select_info</span>, _tag, select}} <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Logger</span><span style=color:#f92672>.</span>info(%{<span style=color:#e6db74>select</span>: select})
</span></span><span style=display:flex><span>    {<span style=color:#e6db74>:noreply</span>, %{state <span style=color:#f92672>|</span> <span style=color:#e6db74>select</span>: select}}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    {<span style=color:#e6db74>:ok</span>, {source, data}} <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Logger</span><span style=color:#f92672>.</span>info(%{<span style=color:#e6db74>source</span>: source, <span style=color:#e6db74>data</span>: data})
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>:inet</span><span style=color:#f92672>.</span>parse_ipv6_address(<span style=color:#a6e22e>String</span><span style=color:#f92672>.</span>to_charlist(data)) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        {<span style=color:#e6db74>:ok</span>, _addr} <span style=color:#f92672>-&gt;</span> 
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#e6db74>:&#34;myapp@</span><span style=color:#e6db74>#{</span>data<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> <span style=color:#a6e22e>Node</span><span style=color:#f92672>.</span>list() <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Logger</span><span style=color:#f92672>.</span>info(%{<span style=color:#e6db74>connecting_node</span>: <span style=color:#e6db74>:&#34;myapp@</span><span style=color:#e6db74>#{</span>data<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>})
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Node</span><span style=color:#f92672>.</span>connect(<span style=color:#e6db74>:&#34;myapp@</span><span style=color:#e6db74>#{</span>data<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Logger</span><span style=color:#f92672>.</span>info(%{<span style=color:#e6db74>already_connected</span>: <span style=color:#e6db74>:&#34;myapp@</span><span style=color:#e6db74>#{</span>data<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>})
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>        data <span style=color:#f92672>-&gt;</span> 
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Logger</span><span style=color:#f92672>.</span>warning(%{<span style=color:#e6db74>unknown_data</span>: data}) 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    {<span style=color:#e6db74>:noreply</span>, state, {<span style=color:#e6db74>:continue</span>, <span style=color:#e6db74>:recvfrom</span>}}
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>Which just tries to decode the data from the socket as a string&rsquo;d ip address, and checks to see if our node is already connected. If not, attempt to connect to it.</p><h2 id=conclusion>Conclusion<a href=#conclusion class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Now wrap all of that up into a small GenServer process as shown in the begining, and it&rsquo;s job-done. Now of course there are <strong>many</strong> optimizations to be made from this starting point. in no particular order, some of the low hanging fruit is</p><ul><li>use a PSK on the mesh network. The network in this example is completely open. anyone who knows how could connect and mess things up, or even passively listen to packets.</li><li>use the TLS Erlang distribution transport. The NervesKey hardware supports hardware enabled encryption and other related features. This would involve some SSL work but would encrypt the distribution network.</li><li>monitor other nodes. This could be done to validate the network is working. Depends on the end use application, but probably good practice.</li><li>bridge the mesh network with other links. ULA addresses aren&rsquo;t meant to be exposed on the public ipv6 internet, but this same addressing strategy would also work for global addresses.</li><li>smarter discovery protocol. MDNS, upnp or similar solutions may be easy to setup here.</li></ul></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=https://cone.codes/posts/can-link-pt-4/><span class=button__text>CAN Link Part 4</span>
<span class=button__icon>→</span></a></span></div></div></div></div><span style=display:inline-block;margin-left:1em>© 2022 <a href=https://cone.codes>Connor Rigby </a><a href=https://creativecommons.org/licenses/by-sa/4.0/>CC BY-SA</a>
<a rel=me href=https://fosstodon.org/@PressY4Pie>Mastodon</a>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span></div></body></html>