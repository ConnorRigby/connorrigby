<!doctype html><html lang=en><head><title>Using Zig to Build Native Lua Scripts :: cone.codes</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Using Zig to Cross compile a Lua script for multiple arches"><meta name=keywords content="zig,lua"><meta name=robots content="noodp"><link rel=canonical href=https://cone.codes/posts/using-zig-to-build-native-lua-scripts/><link rel=stylesheet href=https://cone.codes/assets/style.css><link rel=stylesheet href=https://cone.codes/assets/pink.css><link rel=apple-touch-icon href=https://cone.codes/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://cone.codes/img/favicon/pink.png><meta name=twitter:card content="summary"><meta name=twitter:site content="https://connorrigby.github.io/connorrigby/"><meta name=twitter:creator content="PressY4Pie"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Using Zig to Build Native Lua Scripts"><meta property="og:description" content="Using Zig to Cross compile a Lua script for multiple arches"><meta property="og:url" content="https://cone.codes/posts/using-zig-to-build-native-lua-scripts/"><meta property="og:site_name" content="cone.codes"><meta property="og:image" content="https://cone.codes/img/favicon/pink.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2022-02-03 20:02:05 -0700 -0700"></head><body class=pink><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>cone.codes</div></a></div></div></header><div class=content><div class=post><h1 class=post-title><a href=https://cone.codes/posts/using-zig-to-build-native-lua-scripts/>Using Zig to Build Native Lua Scripts</a></h1><div class=post-meta><span class=post-date>2022-02-03</span>
<span class=post-author>:: Connor Rigby</span></div><span class=post-tags>#<a href=https://cone.codes/tags/ziglang/>ziglang</a>&nbsp;
#<a href=https://cone.codes/tags/zig/>zig</a>&nbsp;
#<a href=https://cone.codes/tags/lua/>lua</a>&nbsp;</span><div class=post-content><div><h1 id=using-zig-to-build-native-lua-scripts>Using Zig to build Native Lua Scripts<a href=#using-zig-to-build-native-lua-scripts class=hanchor arialabel=Anchor>&#8983;</a></h1><p>I&rsquo;ve been playing with <a href=https://ziglang.org/>Zig</a> a lot lately.
It&rsquo;s one of my favorite pieces of tech I&rsquo;ve found in
the last few years. One of my favorite features is how easy it
is to compile C libraries with it. Of course
when I think &ldquo;C libraries&rdquo;, the first that comes to mind is <code>Lua</code>.</p><p>Lua is a really cool &ldquo;embeddable&rdquo; progrramming language. It&rsquo;s
made to be put &ldquo;inside&rdquo; larger projects primarily. Some examples
of things that use Lua include</p><ul><li><a href=https://love2d.org/>LÖVE</a></li><li><a href=https://www.nginx.com/resources/wiki/modules/lua/>Nginx</a></li><li><a href=https://wowwiki-archive.fandom.com/wiki/Lua>World of Warcraft</a></li></ul><p>So of course, to run in so many places, Lua itself has been built
from the ground up to be &ldquo;embedded&rdquo;. It is distributed as an archive
C source files and documentation. This is great news for us with Zig,
since <a href=https://andrewkelley.me/post/zig-cc-powerful-drop-in-replacement-gcc-clang.html>Zig is a c compiler</a>!</p><p>Getting Lua to compile inside a Zig project is <em>really</em> easy! easier than
C/C++ in my opinion. I&rsquo;ll glaze the details, plucking the important parts</p><p>First, in <code>build.zig</code>, we need to link libc, and add it&rsquo;s source files.
This looks like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zig data-lang=zig><span style=display:flex><span><span style=color:#66d9ef>const</span> exe <span style=color:#f92672>=</span> b.addExecutable(<span style=color:#e6db74>&#34;wrapper&#34;</span>, <span style=color:#e6db74>&#34;wrapper.zig&#34;</span>);
</span></span><span style=display:flex><span>exe.setTarget(target);
</span></span><span style=display:flex><span>exe.setBuildMode(mode);
</span></span><span style=display:flex><span>exe.linkLibC();
</span></span><span style=display:flex><span>exe.addIncludeDir(<span style=color:#e6db74>&#34;lua-5.3.4/src&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> lua_c_files <span style=color:#f92672>=</span> [_][]<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>u8</span>{
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;lapi.c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;lauxlib.c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;lbaselib.c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;lbitlib.c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;lcode.c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;lcorolib.c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;lctype.c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ldblib.c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ldebug.c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ldo.c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ldump.c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;lfunc.c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;lgc.c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;linit.c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;liolib.c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;llex.c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;lmathlib.c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;lmem.c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;loadlib.c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;lobject.c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;lopcodes.c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;loslib.c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;lparser.c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;lstate.c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;lstring.c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;lstrlib.c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ltable.c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ltablib.c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ltm.c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;lundump.c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;lutf8lib.c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;lvm.c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;lzio.c&#34;</span>,
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span>(target.os_tag <span style=color:#f92672>==</span> std.Target.Os.Tag.windows) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> c_flags <span style=color:#f92672>=</span> [_][]<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>u8</span>{
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;-std=c99&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;-O2&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;-DLUA_USE_WINDOWS&#34;</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>inline</span> <span style=color:#66d9ef>for</span> (lua_c_files) <span style=color:#f92672>|</span>c_file<span style=color:#f92672>|</span> {
</span></span><span style=display:flex><span>        exe.addCSourceFile(<span style=color:#e6db74>&#34;lua-5.3.4/src/&#34;</span> <span style=color:#f92672>++</span> c_file, <span style=color:#f92672>&amp;</span>c_flags);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> c_flags <span style=color:#f92672>=</span> [_][]<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>u8</span>{
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;-std=c99&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;-O2&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;-DLUA_USE_POSIX&#34;</span>,
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>inline</span> <span style=color:#66d9ef>for</span> (lua_c_files) <span style=color:#f92672>|</span>c_file<span style=color:#f92672>|</span> {
</span></span><span style=display:flex><span>        exe.addCSourceFile(<span style=color:#e6db74>&#34;lua-5.3.4/src/&#34;</span> <span style=color:#f92672>++</span> c_file, <span style=color:#f92672>&amp;</span>c_flags);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>exe.install();
</span></span></code></pre></div><p>That&rsquo;s really it! It even adds support for Windows. All that&rsquo;s
left is to just use it. This works like any other C library with Zig.
For this project, I decided I would make a single executable out of a
Lua script. Here&rsquo;s the source of the Lua script to give additional context:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>print(<span style=color:#e6db74>&#34;press Y&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> input <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span>(input <span style=color:#f92672>~=</span> <span style=color:#e6db74>&#39;y&#39;</span> <span style=color:#f92672>and</span> input <span style=color:#f92672>~=</span> <span style=color:#e6db74>&#39;Y&#39;</span>) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  input <span style=color:#f92672>=</span> io.read(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;🥧&#34;</span>)
</span></span></code></pre></div><p>So all the Zig code needs to do is somehow &ldquo;embed&rdquo; that script, and execute it
inside of the Lua VM. Lua offers a <code>luac</code> executable to compile a script file
into a chunk of Lua bytecode that can then be executed. This isn&rsquo;t strictly
necessary, but i compiled the <code>luac</code> executable with Zig:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make -C lua-5.3.4/ generic CC<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;zig cc&#34;</span>
</span></span></code></pre></div><p>Next I compiled my script:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./lua-5.3.4/src/luac main.lua
</span></span></code></pre></div><p>Which outputs a <code>luac.out</code> file. This itself obviously isn&rsquo;t an executable tho.
Luckily, Zig has a built-in for us to use:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zig data-lang=zig><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>const</span> LUA_BYTECODE <span style=color:#f92672>=</span> @embedFile(<span style=color:#e6db74>&#34;luac.out&#34;</span>);
</span></span></code></pre></div><p>Finally, all that&rsquo;s left is to execute the bytecode with <code>lua_pcallk</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zig data-lang=zig><span style=display:flex><span><span style=color:#66d9ef>const</span> lua <span style=color:#f92672>=</span> @cImport({
</span></span><span style=display:flex><span>    @cInclude(<span style=color:#e6db74>&#34;lua.h&#34;</span>);
</span></span><span style=display:flex><span>    @cInclude(<span style=color:#e6db74>&#34;lualib.h&#34;</span>);
</span></span><span style=display:flex><span>    @cInclude(<span style=color:#e6db74>&#34;lauxlib.h&#34;</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> main() <span style=color:#66d9ef>anyerror</span><span style=color:#f92672>!</span><span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> s <span style=color:#f92672>=</span> lua.luaL_newstate();
</span></span><span style=display:flex><span>    lua.luaL_openlibs(s);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> load_status <span style=color:#f92672>=</span> lua.luaL_loadbufferx(s, LUA_BYTECODE, LUA_BYTECODE.len, <span style=color:#e6db74>&#34;main.lua&#34;</span>, <span style=color:#e6db74>&#34;bt&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (load_status <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        std.log.info(<span style=color:#e6db74>&#34;Couldn&#39;t load lua bytecode: {s}&#34;</span>, .{lua.lua_tolstring(s, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#66d9ef>null</span>)});
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> call_status <span style=color:#f92672>=</span> lua.lua_pcallk(s, <span style=color:#ae81ff>0</span>, lua.LUA_MULTRET, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (call_status <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        std.log.info(<span style=color:#e6db74>&#34;{s}&#34;</span>, .{lua.lua_tolstring(s, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#66d9ef>null</span>)});
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I tested this out on my arm Mac, an x86 Mac, my Windows PC, WSL, and on several
Linux installations and it works great!</p><p>Compiling is done with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>zig build -Drelease-small -Dtarget<span style=color:#f92672>=</span>&lt;target&gt;
</span></span></code></pre></div><p>Where target can be one of:</p><ul><li><code>x86_64-windows</code></li><li><code>x86_64-macos</code></li><li><code>aarch64-macos</code></li><li><code>aarch64-linux-musl</code></li><li><code>x86_64-linux-musl</code></li></ul><p>I&rsquo;m sure there are other targets that work, but those are the ones
I tested.</p><p>All the source for this project is <a href=https://github.com/ConnorRigby/zig-lua-wrapper>On Github</a>
I also uploaded precompiled binaries to Github as well: <a href=https://github.com/ConnorRigby/zig-lua-wrapper/releases/tag/22-2-3>Here</a>.</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://cone.codes/posts/can-link/><span class=button__icon>←</span>
<span class=button__text>Can Link</span></a></span>
<span class="button next"><a href=https://cone.codes/posts/encrypted-sqlite-with-ecto/><span class=button__text>Encrypted SQLite With Ecto</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>Creative Commons Attribution 4.0 International</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://cone.codes/assets/main.js></script>
<script src=https://cone.codes/assets/prism.js></script></div></body></html>