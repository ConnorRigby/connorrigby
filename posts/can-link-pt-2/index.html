<!doctype html><html lang=en><head><title>CAN Link Part 2 :: cone.codes</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Automotive Nerves Project - RGB Controller with CAN Interface Part 2"><meta name=keywords content="linux,elixir,nerves"><meta name=robots content="noodp"><link rel=canonical href=https://cone.codes/posts/can-link-pt-2/><script async src="https://www.googletagmanager.com/gtag/js?id=G-232FYPH9EF"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-232FYPH9EF",{anonymize_ip:!1})}</script><link rel=stylesheet href=https://cone.codes/assets/style.css><link rel=stylesheet href=https://cone.codes/assets/pink.css><link rel=apple-touch-icon href=https://cone.codes/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://cone.codes/img/favicon/pink.png><meta name=twitter:card content="summary"><meta name=twitter:site content="https://connorrigby.github.io/connorrigby/"><meta name=twitter:creator content="PressY4Pie"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="CAN Link Part 2"><meta property="og:description" content="Automotive Nerves Project - RGB Controller with CAN Interface Part 2"><meta property="og:url" content="https://cone.codes/posts/can-link-pt-2/"><meta property="og:site_name" content="cone.codes"><meta property="og:image" content="https://media.discordapp.net/attachments/957852929254113300/962088847506800690/unknown.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2022-04-08 15:19:25 -0600 -0600"></head><body class=pink><div class="container full headings--one-size"><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-232FYPH9EF"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-232FYPH9EF",{anonymize_ip:!1})}</script><script>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-232FYPH9EF","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><div class=content><div class=post><h1 class=post-title><a href=https://cone.codes/posts/can-link-pt-2/>CAN Link Part 2</a></h1><div class=post-meta><span class=post-date>2022-04-08
</span><span class=post-author>:: Connor Rigby</span></div><span class=post-tags>#<a href=https://cone.codes/tags/can-link/>can-link</a>&nbsp;
#<a href=https://cone.codes/tags/elixir/>elixir</a>&nbsp;
#<a href=https://cone.codes/tags/nerves/>nerves</a>&nbsp;
#<a href=https://cone.codes/tags/embedded-linux/>embedded linux</a>&nbsp;
#<a href=https://cone.codes/tags/linux/>linux</a>&nbsp;
</span><img src=https://media.discordapp.net/attachments/957852929254113300/962088847506800690/unknown.png class=post-cover alt="CAN Link Part 2" title="Cover Image"><div class=post-content><div><p>Last week, I closed with</p><blockquote><p>I ordered a few OSD335X chips on Aliexpress. Tune back in next week to see if they show up or not.</p></blockquote><p>Well, it&rsquo;s next week, and my order got canceled. I ordered s&rsquo;more from other places, and it was canceled. I Couldn&rsquo;t even find anywhere that had a <em>single</em> SOM for me to buy. Best I could find was <a href=https://en.wikipedia.org/wiki/MOQ>Minimum Order Quantity</a> of 250 pieces. So I did what any reasonable person would do; Desoldered some from old, broken boards.</p><p><img alt=desoldered-som src="https://media.discordapp.net/attachments/643947340453118019/961053924801011712/IMG_20220405_180317.jpg?width=759&height=1012">.</p><p>Then after sleeping on the idea of desoldering 10+ of these, I realized this probably isn&rsquo;t the move for this project.</p><p>As a side note</p><blockquote><p>FS: 1 (one) OSD3558-512M-BAS, slightly used $1000 OBO</p></blockquote><p>So I had a look through <a href=https://octopart.com/>Octopart</a>, and decided that this project was dumb and gave up.</p><h2 id=redesigning-the-pcb>Redesigning the PCB<a href=#redesigning-the-pcb class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Then I made some coffee, sat down, and got to work redesigning the PCB for a <a href=https://www.raspberrypi.com/products/compute-module-4/>Raspberry Pi Compute Module</a>. These are really cool modules, but not really specced for this application. They are obviously targeted at media applications, not industrial control protocols or much/any interaction with the outside world. Buuuut they do have one good thing going for them - I can get a few of them. Below is a table showing some of the important differences in the main CPUs.</p><table><thead><tr><th style=text-align:center>SOM</th><th style=text-align:center>CPU Clock Speed</th><th style=text-align:center>CPU Cores</th><th style=text-align:center>RAM</th><th style=text-align:center>Available PWM</th><th style=text-align:center>USB Ports</th><th style=text-align:center>Native CAN support</th><th style=text-align:center>CSI (camera) ports</th><th style=text-align:center>DSI (display) ports</th><th style=text-align:center>HDMI ports</th><th></th></tr></thead><tbody><tr><td style=text-align:center>OSD335x</td><td style=text-align:center>900 MHz</td><td style=text-align:center>1</td><td style=text-align:center>512MB</td><td style=text-align:center>a lot</td><td style=text-align:center>2</td><td style=text-align:center>yes</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td style=text-align:center>0</td><td></td></tr><tr><td style=text-align:center>CM4</td><td style=text-align:center>1.4 GHz</td><td style=text-align:center>4</td><td style=text-align:center>1-8 GB</td><td style=text-align:center>2 (3 are required)</td><td style=text-align:center>1 (2 were desired )</td><td style=text-align:center>no (required)</td><td style=text-align:center>2</td><td style=text-align:center>2</td><td style=text-align:center>2</td><td></td></tr></tbody></table><p>Soooo, while it technically is easier to obtain, the next issue is finding external components to do all the stuff I don&rsquo;t need, notably CAN and RGB (the literal only requirements for this project).</p><p>Irritated, I hopped back onto OctoPart and started component hunting. First up was something about the PWM issue. I had two ideas for this, so to prevent further redesigns I decided to lay out both, just in case. The most straightforward solution is using some sort of IO Expander chip. I knew of one right off the top of my head: <a href="https://www.futureelectronics.com/p/semiconductors--analog--drivers--led-drivers-linear-mode/PCA9685PW-112-nxp-1019213?utm_source=octopart&utm_medium=aggregator&utm_campaign=crossref&utm_term=PCA9685PW%2C112">NXP PCA9685PW,112</a>. It&rsquo;s made specifically for controlling RGB LEDs via <a href=https://en.wikipedia.org/wiki/I%C2%B2C>I²C</a>. Features include: <a href=https://github.com/torvalds/linux/blob/master/drivers/pwm/pwm-pca9685.c>already having a driver in Linux</a> and being pretty straight forward to design around. Bad news is it&rsquo;s really popular so I can&rsquo;t find it anywhere. So, the backup then: <a href=https://www.raspberrypi.com/products/raspberry-pi-pico/>A Raspberry Pi Pico</a>. I originally planned on using just the RP2040 chip, but you guessed it - out of stock. I connected it to the CM4 via I²C, and slapped it down on the board.</p><p>The other missing main component is something that speaks <a href=https://en.wikipedia.org/wiki/CAN_bus>CAN</a>. Again, I already had an idea for this as well. <a href=https://www.microchip.com/en-us/product/MCP2515>The MCP2515</a>. It&rsquo;s old, it&rsquo;s not recommended for new designs, and I have a bunch of them in different packages on the shelf. Not much else to say about this chip other than because I have a bunch of them in 2 different packages, I plopped down a footprint for both of them on the board so I can just solder whichever without spinning a new board:</p><p><img alt="MCP Dual footprints" src=https://media.discordapp.net/attachments/643947340453118019/961786045333119076/unknown.png></p><p>In the shot above, <code>U8</code> and <code>U5</code> are both a <code>MCP2515</code>, just in two different packages. (also photo&rsquo;d is the <code>pca9685</code> chip above.)</p><p>The other thing I tested this week was the &ldquo;hack&rdquo; of using a set of BSS138 N channel transistors to do the LED PWMing.</p><p><img alt="BSS138 prototype" src="https://media.discordapp.net/attachments/643947340453118019/960593404012675132/IMG_20220404_113438.jpg?width=759&height=1012"></p><p>As it turns out, they are not suitable for this application. When I threw these prototype boards on my bench supply connected to the prototype, I managed to melt the transistor at 12V @ 2A. I <strong>could</strong> just limit the brightness in software, but since I&rsquo;m spinning the board anyway, I replaced them with a set of <a href=https://en.wikipedia.org/wiki/MOSFET>Mosfets</a>.</p><p>Finally, after about a day of rerouting and updating everything, I was left with the new PCB. The best part, 93% procurable component selection.</p><p><img alt=octopart-bom src=https://media.discordapp.net/attachments/957852929254113300/962089782127788072/unknown.png></p><p><img alt=rerouted-pcb-final src=https://media.discordapp.net/attachments/957852929254113300/962088847506800690/unknown.png></p><h2 id=conclusions>Conclusions<a href=#conclusions class=hanchor arialabel=Anchor>&#8983;</a></h2><p>I&rsquo;m not super happy that I had to go through all this, but for what it&rsquo;s worth, using the CM4 module was <em>very</em> easy, Even if it&rsquo;s not the perfect selection. I really wanted to use the OSD335x chip since it&rsquo;s a really cool chip, and has all the stuff I need built right into it. I&rsquo;m sure I <strong>could</strong> have hunted around for another SOM. Several come to mind, the OSD32MP1, Most of the IMX line, etc. But upon quick searches, they are all just as hard to get as the OS335x.
The other interesting part of all of this is that the BOM price actually went down by quite a bit. I wasn&rsquo;t keeping super good track of this since most of the components I selected for the original design are out of stock and therefor artifically inflated in price. It&rsquo;s kind of frustrating that it was easier to use something designed for set top boxes than it was to use something purpose built for my project but oh well.</p><p>Tune back in next week to see if I give entirely for real this time.</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://cone.codes/posts/can-link-pt-3/><span class=button__icon>←</span>
<span class=button__text>CAN Link Part 3</span>
</a></span><span class="button next"><a href=https://cone.codes/posts/nerves-pwm/><span class=button__text>Using PWM with Nerves</span>
<span class=button__icon>→</span></a></span></div></div></div></div><span style=display:inline-block;margin-left:1em>© 2022 <a href=https://cone.codes>Connor Rigby </a><a href=https://creativecommons.org/licenses/by-sa/4.0/>CC BY-SA</a>
<a rel=me href=https://fosstodon.org/@PressY4Pie>Mastodon</a>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span></div></body></html>